document.addEventListener('DOMContentLoaded', function(event) {
  var app = new Vue({

    el: '#weather',
    data: {
      zipcode: '',
      currentCity: 'Chicago',


      weatherReport: [],

      lastSearch: 0,
      loading: false,
      cache: {},
      errors: []


    },

    methods: {

      tooFast: function(now) {
        if (this.lastSearch + 2000 > now) {
          this.errors = ['You\'re requesting too often! Wait at least 2 seconds'];
        } else {
          this.errors = [];
          this.searchZipcode()
          this.findCity
        };
      },

      searchZipcode: function() {
        this.errors = ['Zipcode cannot be blank.', 'Zipcode must be 5 numbers. IE: 60622' ]

        if (this.zipcode != '') {
          this.weatherReport = [];
          this.loading = true;
          this.errors = []
          this.lastSearch = Date.now()

          if (this.fetch(this.zipcode)) {
            var weatherInfo = this.fetch(this.zipcode)

            for (var i = 0; i < 3; i++) {
              this.weatherReport.push(weatherInfo[i]);
            };

            this.zipcode = '';
            this.loading = false;
          } else {
            $.get('http://api.wunderground.com/api/624c587a66ec60af/forecast/q/' + this.zipcode +'.json', function(list) {

              if (list['forecast']) {
                for (var i = 0; i < 3; i++) {
                  this.weatherReport.push(list['forecast']['simpleforecast']['forecastday'][i]);
                  this.findCity()
                };
              } else if (list['response']){
                this.errors = [list['response']['error']['description']]
                this.loading = false;

              };

            }.bind(this))
          }
        }
      },

      findCity: function() {
        $.get('http://api.wunderground.com/api/624c587a66ec60af/conditions/q/' + this.zipcode +'.json', function(info) {

          if (info['current_observation']) {
            this.currentCity = info['current_observation']['display_location']['full'];
            this.store(this.zipcode, this.weatherReport, this.currentCity);

          } else {
            this.errors.push('There was an issue retrieving the city name. Please try again');
          }
        }.bind(this));
      },

      store: function(zipcode, weather, city) {

        object = {
          timestamp: Date.now(),
          city: city,
          weather: weather,
        };

        localStorage[zipcode] = JSON.stringify(object);
        this.loading = false;
        this.zipcode = '';
      },

      fetch: function(zipcode) {
        var object = localStorage[zipcode]


        if(object) {
          if (JSON.parse(object).timestamp + 3600000 > Date.now()) {
            this.currentCity = JSON.parse(object).city
            return JSON.parse(object).weather;
          } else {
            localStorage.removeItem(zipcode);
            return null;
          };
        } else {
          return null;
        };
      }
    },

    mounted: function() {
      console.log( <%= Rails.application.secrets.wunderground_key %> )
    }

  });
})